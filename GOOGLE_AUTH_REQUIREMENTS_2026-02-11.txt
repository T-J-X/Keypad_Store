Google Auth Requirements (Vendure + Next.js Direct Integration)
Date: 2026-02-11
Architecture: Frontend 3001 (Next.js), Backend 3000 (Vendure)

Current implementation status
Backend
- Google strategy class exists: apps/backend/src/auth/google-authentication-strategy.ts
- Strategy name is 'google' and is registered in shopAuthenticationStrategy in apps/backend/src/index.ts
- Strategy supports token or authorization code + redirectUri.
- Uses ExternalAuthenticationService for user/customer mapping.

Frontend
- Login start route exists: apps/storefront/app/api/auth/google/route.ts
- OAuth callback route exists: apps/storefront/app/api/auth/google/callback/route.ts
- Callback validates state cookie and exchanges code/token with Vendure authenticate mutation (strategy key google).
- Login UI button exists: apps/storefront/components/GoogleLoginButton.tsx

Required environment variables
Backend (apps/backend/.env)
- GOOGLE_CLIENT_ID=...
- GOOGLE_CLIENT_SECRET=...
- GOOGLE_OAUTH_REDIRECT_URI=... (optional if default callback is used)

Frontend (apps/storefront/.env.local)
- VENDURE_SHOP_API_URL=http://localhost:3000/shop-api
- NEXT_PUBLIC_SITE_URL=http://localhost:3001
- NEXT_PUBLIC_GOOGLE_CLIENT_ID=... (optional fallback for route start; backend GOOGLE_CLIENT_ID is primary)
- GOOGLE_OAUTH_REDIRECT_URI=... (optional override; default is http://localhost:3001/api/auth/google/callback)

Google Cloud Console requirements
1. Create OAuth client credentials for Web application.
2. Authorized JavaScript origins must include:
   - http://localhost:3001
3. Authorized redirect URIs must include:
   - http://localhost:3001/api/auth/google/callback
4. Configure OAuth consent screen and add test users (until app is verified/published).
5. Ensure OpenID scopes are allowed:
   - openid
   - email
   - profile

Backend requirements checklist
- [ ] GOOGLE_CLIENT_ID configured in backend runtime env.
- [ ] GOOGLE_CLIENT_SECRET configured in backend runtime env.
- [ ] GOOGLE_OAUTH_REDIRECT_URI set if not using default callback URL.
- [ ] Backend restarted after env changes.
- [ ] authOptions.shopAuthenticationStrategy includes new GoogleAuthenticationStrategy() (already present).

Frontend requirements checklist
- [ ] .env.local points to correct ports (site 3001, Vendure shop API 3000/shop-api).
- [ ] Google login entry path used by UI: /api/auth/google.
- [ ] Callback path reachable at /api/auth/google/callback.
- [ ] Login page renders Google button and redirects correctly.

Post-config verification steps
1. Open http://localhost:3001/login.
2. Click "Continue with Google".
3. Complete Google flow and confirm redirect back to /account.
4. Call http://localhost:3001/api/session/summary and verify authenticated state.
5. Add item to cart before login, then login with Google, verify cart/session persists.

Known gotchas
- State mismatch errors usually mean callback URI/origin mismatch or stale OAuth cookies.
- If Google is configured but login still fails, confirm strategy key in mutation is exactly 'google'.
- Keep Vendure session cookies same-site compatible (already set to sameSite=lax, httpOnly, secure in production).
