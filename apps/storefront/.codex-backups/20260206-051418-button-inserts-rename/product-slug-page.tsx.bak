import Link from 'next/link';
import { notFound } from 'next/navigation';
import { assetUrl, iconCategoriesFromProduct } from '../../../lib/vendure';
import { fetchProductBySlug } from '../../../lib/vendure.server';

type ProductSearchParams = {
  from?: string | string[];
  section?: string | string[];
  cat?: string | string[];
};

type BreadcrumbItem = {
  label: string;
  href?: string;
};

function toStringParam(value?: string | string[]) {
  return typeof value === 'string' ? value : '';
}

function toCategoryLabelFromSlug(slug: string) {
  return slug
    .split('-')
    .filter(Boolean)
    .map((part) => part.charAt(0).toUpperCase() + part.slice(1))
    .join(' ');
}

function buildShopHref(section?: 'icons' | 'keypads', categorySlug = '') {
  const params = new URLSearchParams();
  if (section) params.set('section', section);
  if (section === 'icons' && categorySlug) params.set('cat', categorySlug);
  const query = params.toString();
  return `/shop${query ? `?${query}` : ''}`;
}

export default async function ProductDetailPage({
  params,
  searchParams,
}: {
  params: Promise<{ slug: string }>;
  searchParams?: Promise<ProductSearchParams>;
}) {
  const resolvedParams = await params;
  const resolvedSearchParams = await searchParams;
  const product = await fetchProductBySlug(resolvedParams.slug);
  if (!product) return notFound();

  const origin = toStringParam(resolvedSearchParams?.from);
  const sectionParam = toStringParam(resolvedSearchParams?.section);
  const categoryParam = toStringParam(resolvedSearchParams?.cat);
  const section =
    sectionParam === 'keypads' ? 'keypads' : sectionParam === 'icons' ? 'icons' : undefined;

  const image = product.featuredAsset?.preview ?? product.featuredAsset?.source ?? '';
  const iconId = product.customFields?.iconId ?? product.name;
  const isKeypad = Boolean(product.customFields?.isKeypadProduct);
  const iconCategories = iconCategoriesFromProduct(product);
  const categoryLabel = iconCategories.length > 0 ? iconCategories.join(', ') : 'Uncategorised';

  const breadcrumbs: BreadcrumbItem[] = origin === 'shop'
    ? [
      { label: 'Shop', href: buildShopHref() },
      ...(section === 'icons' ? [{ label: 'Icons', href: buildShopHref('icons') }] : []),
      ...(section === 'icons' && categoryParam
        ? [{ label: toCategoryLabelFromSlug(categoryParam), href: buildShopHref('icons', categoryParam) }]
        : []),
      ...(section === 'keypads' ? [{ label: 'Keypads', href: buildShopHref('keypads') }] : []),
      { label: product.name },
    ]
    : [
      { label: 'Home', href: '/' },
      { label: product.name },
    ];

  return (
    <div className="mx-auto w-full max-w-5xl px-6 pb-20 pt-12">
      <div className="mb-6 text-xs font-semibold uppercase tracking-wide text-ink/50">
        <nav aria-label="Breadcrumb">
          <ol className="flex flex-wrap items-center gap-2">
            {breadcrumbs.map((crumb, index) => (
              <li key={`${crumb.label}-${index}`} className="flex items-center gap-2">
                {crumb.href ? (
                  <Link href={crumb.href} className="hover:text-ink">{crumb.label}</Link>
                ) : (
                  <span className="text-ink">{crumb.label}</span>
                )}
                {index < breadcrumbs.length - 1 && <span className="text-ink/35">/</span>}
              </li>
            ))}
          </ol>
        </nav>
      </div>
      <div className="grid gap-10 lg:grid-cols-[1fr_0.9fr]">
        <div className="card-soft flex items-center justify-center p-8">
          {image ? (
            <img src={assetUrl(image)} alt={product.name} className="h-72 w-full object-contain" />
          ) : (
            <div className="text-xs font-semibold uppercase tracking-wide text-ink/40">Render pending</div>
          )}
        </div>
        <div className="space-y-5">
          <div className="pill">{isKeypad ? 'Keypad Catalog' : 'Insert Catalog'}</div>
          <div>
            <h1 className="text-3xl font-semibold tracking-tight text-ink md:text-4xl">{product.name}</h1>
            <div className="mt-2 text-sm text-ink/60">{isKeypad ? 'Keypad model' : 'Insert product'}</div>
          </div>
          {!isKeypad && (
            <div className="space-y-1 text-sm text-ink/70">
              <div>Insert ID: <span className="font-semibold text-ink">{iconId}</span></div>
              <div>Categories: <span className="font-semibold text-ink">{categoryLabel}</span></div>
            </div>
          )}
          <p className="text-sm text-ink/60">
            This page is a lightweight shell for future expansion. It will eventually include configurator previews,
            inventory status, and ordering controls.
          </p>
          {isKeypad ? (
            <Link href={`/configurator/${product.slug}`} className="btn-primary inline-flex w-fit">Configure now</Link>
          ) : (
            <Link href="/configurator" className="btn-primary inline-flex w-fit">Add to configuration</Link>
          )}
          <div className="card-soft p-4 text-xs text-ink/60">
            Note: Storefront pages only display the featured render asset. Insert overlays remain configurator-only.
          </div>
        </div>
      </div>
    </div>
  );
}
